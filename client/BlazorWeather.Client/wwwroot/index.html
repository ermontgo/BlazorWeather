<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width">
    <title>BlazorWeather.Client</title>
    <base href="/" />
    <link href="css/bootstrap/bootstrap.min.css" rel="stylesheet" />
    <link href="css/site.css" rel="stylesheet" />
</head>
<body>
    <app>Loading...</app>

    <script src="_framework/blazor.webassembly.js"></script>
    <script type="text/javascript" src="https://www.bing.com/api/maps/mapcontrol?key=***REMOVED***"></script>
    <script type="text/javascript">
        window.maps = (function () {
            function buildKey(element) {
                var key = "";
                var parentElem = element;
                while (parentElem != null) {
                    nodeKey = parentElem.localName;
                    if (parentElem.id !== "") {
                        nodeKey += "#" + parentElem.id;
                    }
                    else if (parentElem.className !== "") {
                        nodeKey += "." + parentElem.className;
                    }

                    key = nodeKey + " " + key;

                    parentElem = parentElem.parentElement;
                }

                return key;
            }

            function getTempColor(temp) {
                var tempColor = "purple";
                if (temp > 95) tempColor = 'red';
                else if (temp > 80) tempColor = 'yellow';
                else if (temp > 55) tempColor = 'green';
                else if (temp > 32) tempColor = 'blue';

                return tempColor;
            }

            function addPushpin(map, detail) {
                var temp = detail.temperatureDegreesFahrenheit;
                var lat = detail.latitude;
                var lng = detail.longitude;

                var tempColor = getTempColor(temp);

                var loc = new Microsoft.Maps.Location(lat, lng);
                var pushpin = new Microsoft.Maps.Pushpin(loc, { color: tempColor });
                map.entities.push(pushpin);

                return loc;
            }

            function registerPushpinsInternal(mapElement, details) {
                var key = buildKey(mapElement);
                var map = window.maps[key];

                if (map === undefined || map === null) {
                    throw new Error("No map exists for element " + key);
                }

                map.entities.clear();

                var locs = []
                for (var i = 0, len = details.length; i < len; i++) {
                    locs[i] = addPushpin(map, details[i]);
                }

                var rect = Microsoft.Maps.LocationRect.fromLocations(locs);
                map.setView({ bounds: rect, padding: 80 });
            }

            return {
                initializeMapElement: function (element, pushpins) {
                    var key = buildKey(element);

                    if (window.maps[key] === undefined) {
                        var map = new Microsoft.Maps.Map(element, {});                        
                        window.maps[key] = map;
                    }

                    if (pushpins) registerPushpinsInternal(element, pushpins);
                },
                registerPushpins: function (mapElement, details) {
                    registerPushpinsInternal(mapElement, details);
                }
            }
        })();
    </script>
</body>
</html>
